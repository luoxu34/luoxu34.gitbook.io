# 自建服务日志收集、分析和监控

## 统一

* 散：一套服务由多个进程协同，并部署在多台服务器上，日志最后散落在某台服务器上的某个目录，不得不一台一台找日志
* 乱：不同开发者和项目组对日志的处理也不尽相同，缺乏大体一致的统一格式
* 缺：只有服务端的日志，客户端异常从来不上报，出了问题也不知道
* 迟：异常日志都打到文件，但缺乏报警机制，往往要等使用者反馈了再去查日志

系统越来越庞大，服务越来越多，如果出现异常，难道还要等玩家反馈而不能自查吗？知道有异常，却连异常来自哪个类，或者来自哪台服务器都不知道，你乐意这样糊里糊涂吗？

日志其实也是数据，和存储在数据库里的数据一样有价值，只是我们平时不善用它。

## 一个异常产生，附带了多少信息？

1. 异常名，描述信息，日期
2. 抛出者的类名或函数名
3. 行号，文件名，包名（模块名）
4. 进程名
5. 服务名称（应用名称、实例名）
6. 服务所处的容器ID/Hostname/Host IP
7. 部署的项目名，项目版本（可能包含子项目）

如果是客户端日志，可能还需要渠道、设备和玩家信息。

## 哪些日志需要收集？

1. 代码本身的异常报错
2. 某个功能的异常（例如登陆验证失败，如果某个时刻开始，该异常类型数量剧增，基本可断定异常级别并及时报警）
3. 服务与服务之间的通讯失败问题
4. 主机资源占用持续高位
5. mysql的慢日志

## 方案

